# PhotoWatermark-AI4SE 迭代二设计决策文档

## 项目概述
本文档记录了PhotoWatermark-AI4SE迭代二版本的系统设计决策，涵盖GUI框架选择、核心功能实现方案、打包部署方案等关键决策点。

## 技术架构选择

### 1. GUI框架选择
**决策**：采用 tkinter 作为GUI框架

**理由**：
- tkinter是Python内置库，无需额外安装
- 在Windows平台上有良好的兼容性
- 适合开发桌面应用程序
- 界面在Windows系统上显示效果良好
- 与图片预览、文件处理等功能兼容性好

**替代方案考虑**：
- PyQt5/6: 功能更强大但需要额外安装，增加了打包复杂度
- Kivy: 跨平台但可能有兼容性问题

### 2. 图片处理库
**决策**：继续使用 Pillow (PIL)

**理由**：
- 原项目已使用此库，保持一致性
- 支持多种图片格式（JPEG, PNG, BMP, TIFF等）
- 支持透明通道处理
- 支持EXIF信息读取和保存
- 有良好的文本和图像水印处理能力

### 3. 拖拽功能库
**决策**：使用 tkinterdnd2 第三方库

**理由**：
- tkinter原生不支持文件拖拽功能
- tkinterdnd2是成熟的解决方案
- 与tkinter良好兼容

### 4. 可执行文件打包方案
**决策**：采用 PyInstaller 进行打包

**理由**：
- 广泛使用，社区支持良好
- 能够创建独立的可执行文件
- 对tkinter有良好支持
- 支持Windows平台
- 能够有效处理Pillow等依赖库

## 功能模块设计

### 1. 文件处理模块

#### 1.1 文件导入
**设计**：
- 实现拖拽导入功能：使用tkinterdnd2库处理文件拖拽事件
- 实现文件选择器：使用tkinter的filedialog组件
- 实现批量导入：使用tkinter的filedialog组件支持多选
- 实现文件夹导入：使用os.walk或glob模块遍历文件夹
- 图片列表显示：使用Canvas实现带缩略图的列表，显示缩略图和文件名

**技术实现**：
- 使用Pillow生成缩略图
- 过滤支持的图片格式（JPEG, PNG, BMP, TIFF）
- 显示缩略图和文件名

#### 1.2 支持格式
**设计**：
- 输入格式：支持 JPEG, PNG, BMP, TIFF
- 输出格式：支持原格式、JPEG、PNG

**技术实现**：
- 使用Pillow处理不同格式
- 在格式转换时正确处理透明通道（PNG转JPEG时转换为RGB）

#### 1.3 文件导出
**设计**：
- 输出目录选择：使用tkinter的filedialog组件
- 完全禁止覆盖原文件：严格检查输出目录不与输入目录相同
- 文件命名规则：提供保留原名、添加前缀、添加后缀选项
- 输出格式选择：支持原格式、JPEG、PNG格式
- JPEG质量控制：提供滑块组件（Scale）控制1-100的压缩质量
- 图片尺寸调整：提供原图尺寸、按比例缩放、指定宽度、指定高度选项

**技术实现**：
- 使用Pillow的save方法，针对JPEG设置quality参数
- 使用Pillow的resize方法调整尺寸
- 实现动态单位标签显示（px/%）
- 实现默认尺寸值设置

### 2. 水印模块

#### 2.1 文本水印
**设计**：
- 文本输入：使用tkinter的Entry组件
- 字体大小：使用滑块组件（Scale）控制字体大小
- 颜色选择：使用默认白色（后续可扩展）
- 透明度控制：使用滑块组件（Scale）控制0-100透明度
- 位置控制：支持九宫格布局和自定义拖拽位置

**技术实现**：
- 使用Pillow的ImageDraw和ImageFont
- 处理RGBA模式以支持透明度
- 创建文本图层并合成到原图片
- 实现鼠标事件处理以支持拖拽定位

#### 2.2 图片水印（高级功能）
**设计**：（未实现）
- 水印选择：使用filedialog选择水印图片
- 透明度处理：支持PNG透明通道
- 缩放功能：使用滑块控制缩放比例
- 透明度控制：使用滑块控制整体透明度

**技术实现**：（未实现）
- 使用Pillow处理图片缩放和透明度
- 处理PNG透明通道的正确合成

### 3. 布局与样式模块

#### 3.1 实时预览
**设计**：
- 主预览窗口：使用tkinter的Canvas组件显示预览图
- 图片切换：在图片列表中选择不同图片时更新预览
- 实时响应：水印参数修改时立即更新预览

**技术实现**：
- 在Canvas上显示预览图
- 每次参数修改时重新绘制水印
- 考虑性能优化，避免频繁重绘

#### 3.2 位置控制
**设计**：
- 预设位置：提供九宫格按钮（左上、中上、右上、左中、中心、右中、左下、下中、右下）
- 手动拖拽：在预览图上响应鼠标事件，拖拽水印到任意位置

**技术实现**：
- 基于图片尺寸计算九宫格位置坐标
- 使用Canvas事件处理鼠标拖拽
- 记录水印的绝对坐标位置

#### 3.3 旋转功能（高级功能）
**设计**：（未实现）
- 旋转控制：提供滑块或输入框控制旋转角度（-180°到180°）

**技术实现**：（未实现）
- 使用Pillow的rotate方法
- 考虑旋转后图片尺寸变化的处理

### 4. 配置管理模块

#### 4.1 水印模板
**设计**：
- 模板保存：将所有水印参数（内容、字体大小、透明度、位置等）保存为JSON格式
- 模板管理：实现模板的保存、加载、删除功能
- 默认设置：程序启动时加载用户上次使用的设置或默认模板
- UI界面：添加保存、加载、删除按钮及配置名称输入框

**技术实现**：
- 使用Python的json模块处理模板数据
- 将模板保存到用户主目录下的.photowatermark/configs/目录
- 在用户配置目录创建模板存储位置

#### 4.2 应用程序状态管理
**设计**：
- 窗口状态：保存和恢复窗口尺寸、位置
- 所有UI设置：包括水印、导出等所有参数
- 自动加载：程序启动时自动加载上次的设置

**技术实现**：
- 使用JSON格式存储应用程序状态
- 在用户主目录下创建状态文件.photowatermark/app_state.json
- 使用窗口关闭协议确保状态正确保存

## 5. 导出功能增强模块

#### 5.1 选择性导出
**设计**：
- 导出当前图片：添加"导出当前图片"按钮
- 保持与批量导出一致的参数
- 独立的导出流程以满足特定需求

**技术实现**：
- 创建独立的export_current_image方法
- 复用相同的参数设置和处理逻辑
- 确保功能一致性

#### 5.2 导出流程优化
**设计**：
- 减少代码冗余：统一导出逻辑到通用函数
- 功能独立性：保持每个功能模块的独立性
- 顺序一致性：确保所有导出方法使用相同的处理顺序

**技术实现**：
- 创建_process_and_save_image通用方法
- 采用"先加水印再缩放"的正确处理顺序
- 保持各导出方法的独立职责

## UI设计

### 1. 整体布局
**设计**：
- 左侧：图片列表（缩略图和文件名）
- 中间：主预览窗口
- 右侧：参数设置面板（水印类型、内容、位置、样式等）
- 顶部：菜单栏和工具栏
- 底部：导出设置面板和导出按钮

### 2. 控件选择
- 按钮：ttk.Button, ttk.Checkbutton
- 输入框：ttk.Entry, ttk.Combobox
- 滑块：ttk.Scale
- 选择器：colorchooser, filedialog, fontdialog
- 列表：Canvas组件实现的自定义缩略图列表
- 预览：Canvas

### 3. 错误处理UI
**设计**：
- 可复制的错误消息框，支持文本选择和复制

**技术实现**：
- 自定义Toplevel窗口
- 使用scrolledtext组件显示错误信息
- 添加复制到剪贴板按钮

## 数据管理

### 1. 配置文件存储
**设计**：
- 用户配置：保存界面布局、最近使用的设置等
- 模板文件：用户保存的水印配置模板
- 历史记录：保存最近打开的文件夹路径
- 应用程序状态：保存窗口尺寸位置及所有UI状态

**技术实现**：
- 使用JSON格式存储配置信息
- 在用户目录下创建.photowatermark专用配置文件夹
- 分别管理模板(.photowatermark/configs/)和状态(.photowatermark/app_state.json)

### 2. 临时文件处理
**设计**：
- 预览图片：使用内存存储，避免产生临时文件
- 缓存处理：考虑性能优化，对大图进行适当缓存

## 性能考虑

### 1. 大文件处理
- 实现图片缩略图生成时的尺寸限制
- 考虑多线程处理以避免界面冻结
- 实现进度反馈机制

### 2. 实时预览优化
- 对于大尺寸图片，考虑显示缩放版本进行预览
- 避免频繁的水印重绘操作
- 考虑预览图的尺寸限制

## 错误处理

### 1. 文件操作错误
- 检查文件权限
- 处理文件格式错误
- 提供友好的错误提示消息

### 2. 图片处理错误
- 检查图片是否损坏
- 处理不支持的格式
- 提供处理过程中的错误反馈

### 3. 版本兼容性
- 处理不同版本的Pillow库（Image.Resampling vs Image.LANCZOS）

## Windows平台特定考虑

### 1. 文件路径处理
- 统一使用os.path或pathlib处理文件路径
- 确保对Windows反斜杠路径的支持

### 2. 可执行文件打包
- 使用PyInstaller的--onefile参数生成单个可执行文件
- 使用--windowed参数避免控制台窗口
- 考虑防病毒软件误报问题
- 为可执行文件添加适当的图标和版本信息

### 3. 系统兼容性
- 确保在Windows 7/8/10/11上的兼容性
- 考虑高DPI显示的支持
- 遵循Windows应用设计规范

## 模块化架构设计

### 1. 常量管理
**设计**：
- 集中管理所有常量，避免硬编码值
- 提供统一的配置接口

**技术实现**：
- 创建独立的constants.py模块
- 定义图片格式、默认值、UI选项等常量
- 在各模块中导入使用

### 2. 模块初始化
**设计**：
- 各模块提供清晰的公共API
- 使用__all__明确导出的接口

**技术实现**：
- 更新各__init__.py文件
- 定义__all__列表明确模块接口
- 提供清晰的导入接口